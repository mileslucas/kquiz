{% extends "base.html" %}
{% block title %}Home{% endblock %}


{% block content %}
    {% load timedelta_filter %}
    {% load bootstrap4 %}


    <div class="modal fade" id="addQuestion" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add a Question</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'add_question' %}" id="addquestion">
                        {% csrf_token %}
                        {% bootstrap_form add_question_form show_label=False %}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" form="addquestion" class="btn btn-primary">Submit</button>
                </div>


            </div>
        </div>
    </div>


    {% for q in cqs %}
        <div class="card" style="margin-bottom: 20px">
            <div class="card-header question">
                <h3 class="card-title">
                    {{ q }}
                    <small class="text-muted">{{ q.time_left|timedelta:"{minutes}:{seconds2}" }}</small>
                    {% if request.user == q.creator %}
                        <small><a class="badge badge-light" href="{% url 'update_question' q.pk %}">Edit</a></small>
                    {% endif %}
                </h3>
            </div>
            <div class="card-body">
                <blockquote class="blockquote">{{ q.text }}</blockquote>
                {% if q.answer_set.all %}
                    <table class="table table-hover">
                        <thead class="thead-light">
                        <tr>
                            <th>Answers</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for ans in q.answer_set.all %}
                            <tr class="clickable-row" data-href="{% url 'update_answer' ans.pk %}">
                                <td>{{ ans.text }}</td>
                                <td>{{ ans.responder.first_name }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <hr>
                    <p>No answers yet!</p>
                {% endif %}


                <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#answer"
                        aria-expanded="false" aria-controls="answer" id="answerbutton">
                    Answer
                </button>

                <div class="collapse" style="margin-top: 10px" id="answer">
                    <form action="{% url 'add_answer' q.pk %}" method="post">
                        {% csrf_token %}
                        {% bootstrap_form add_answer_form show_label=False %}
                        <input type="submit" style="display: none"/>
                    </form>
                </div>

            </div>
            <div class="card-footer">

                <button type="button" class="btn" data-toggle="modal" data-target="#addQuestion">
                    Add a Question
                </button>
            </div>
        </div>
    {% empty %}
        <h3 class="display-4">There are no current questions...</h3>
        <button type="button" class="btn btn-lg" data-toggle="modal" data-target="#addQuestion">
            Add a Question
        </button>
    {% endfor %}


{% endblock %}

{% block javascript %}
    <script>
        var allowRefresh = true;

        $('#addQuestion').on('show.bs.modal', function () {
            allowRefresh = false;
        });
        $('#addQuestion').on('hide.bs.modal', function () {
            allowRefresh = true;
            refresh();
        });
        $('#answerbutton').click(function () {
            allowRefresh = !allowRefresh;
            $(this).prop('value', '&times;');
            refresh();
        });
        setTimeout(refresh, 1000);

        function refresh() {
            if (allowRefresh) {
                $('body').load('{% url 'dash' %}')
            }
        }

        $(".clickable-row").click(function () {
            window.location = $(this).data("href");
        });
    </script>
{% endblock %}
